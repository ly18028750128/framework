# 说明

此项目只是为了实现异步导入导出功能，不实际限制用那种导出导出方式。

# 集成步骤

# 执行脚本
framework执行init.sql

## maven引用

``` xml
    <dependency>
        <groupId>com.unknow.first</groupId>
        <artifactId>export-import-manager</artifactId>
        <version>0.0.1-SNAPSHOT</version>
    </dependency>
```

## springboot启动类增加

__@EnableFeignClients注解增加：__ "com.unknow.first.imexport.feign"

## 增加job类

```java

@Configuration
public class JobConfig {

    @Bean
    public ImexportTaskRemoteJob imexportTaskRemoteJob(RedisUtil redisUtil,
        ImexportTaskFeignClient imexportTaskFeignClient) {
        return new ImexportTaskRemoteJob(imexportTaskFeignClient, redisUtil);
    }
}
```

## 增加导出服务callable

```java

@Slf4j
public class UserExportService extends ExportCallableService {

    ImexportTaskFeignClient imexportTaskFeignClient;

    public UserExportService(FrameImportExportTask frameImportExportTask) {
        super(frameImportExportTask);
    }

    @Override
    public void init() throws RuntimeException {
        imexportTaskFeignClient = SpringContextUtil.getBean(ImexportTaskFeignClient.class);
        log.info("用户导出初始化，任务Id：{}", frameImportExportTask.getTaskId());
    }

    @Override
    public void process() throws RuntimeException {
        log.info("用户导出执行中，任务Id：{}", frameImportExportTask.getTaskId());
        this.frameImportExportTask.setTaskStatus(ProcessStatus.success.value);
    }

    @SneakyThrows
    @Override
    public void after() throws RuntimeException {
        log.info("用户导出执行结束，任务Id：{}", frameImportExportTask.getTaskId());
    }
}
```

## 创建任务APi

```
curl -X POST -H  "Accept:*/*" -H  "Authorization:basic YWRtaW46MTViYTIwYTI2ZDgxODA4YjVmNWJkOTE0ZjhiMDQ4ZWIlYTFiMmMwazNkNHk4JTkxNmIzNzZkODIxNjBkNDRmODMzMzcwMWQ0OGY4MmFk" -H  "Content-Type:application/json" -d "{\"processClass\":\"com.longyou.comm.service.imexport.UserExportService\",\"taskType\":2,\"fileName\":\"userExport-20222\"}" "http://192.168.30.192:8089/COMMON-SERVICE/user/imexport/task/"
```

``` json
{
  "swagger": "2.0",
  "info": {
    "description": "链自由接口描述",
    "version": "1.0",
    "title": "链自由 Restful Api",
    "termsOfService": "http://127.0.0.1",
    "contact": {
      "name": "链自由",
      "url": "http://127.0.0.1",
      "email": "test.qq.com"
    }
  },
  "host": "192.168.30.192:8089",
  "basePath": "/COMMON-SERVICE",
  "schemes": [],
  "consumes": [
    "*/*"
  ],
  "produces": [
    "*/*"
  ],
  "paths": {
    "/user/imexport/task/": {
      "post": {
        "tags": [
          "用户：导入导出任务管理"
        ],
        "summary": "创建任务",
        "description": "创建任务",
        "operationId": "createUsingPOST_1",
        "consumes": [
          "application/json"
        ],
        "produces": [
          "*/*"
        ],
        "parameters": [
          {
            "in": "body",
            "name": "frameImportExportTask",
            "description": "frameImportExportTask",
            "required": true,
            "schema": {
              "$ref": "#/definitions/导出导出任务表",
              "originalRef": "导出导出任务表"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "OK",
            "schema": {
              "$ref": "#/definitions/导出导出任务表",
              "originalRef": "导出导出任务表"
            }
          },
          "201": {
            "description": "Created"
          },
          "401": {
            "description": "Unauthorized"
          },
          "403": {
            "description": "Forbidden"
          },
          "404": {
            "description": "Not Found"
          }
        }
      }
    }
  },
  "definitions": {
    "导出导出任务表": {
      "type": "object",
      "properties": {
        "dataCorrectCount": {
          "type": "integer",
          "format": "int64",
          "description": "正确行数",
          "refType": null
        },
        "dataCount": {
          "type": "integer",
          "format": "int64",
          "description": "任务总行数",
          "refType": null
        },
        "dataErrorCount": {
          "type": "integer",
          "format": "int64",
          "description": "错误行数",
          "refType": null
        },
        "endTime": {
          "type": "string",
          "format": "date-time",
          "description": "结束执行时间",
          "refType": null
        },
        "errorFileId": {
          "type": "string",
          "description": "文件id，用于存储导入或者导出出错时的文件objectId",
          "refType": null
        },
        "errorFileName": {
          "type": "string",
          "description": "导入或者导出出错时保存错误的文件名",
          "refType": null
        },
        "executeSeconds": {
          "type": "integer",
          "format": "int64",
          "refType": null
        },
        "fileId": {
          "type": "string",
          "description": "文件id，用于存储导入或者导出的文件objectId",
          "refType": null
        },
        "fileName": {
          "type": "string",
          "description": "导入或者导出的文件名",
          "refType": null
        },
        "message": {
          "type": "string",
          "description": "返回消息",
          "refType": null
        },
        "params": {
          "type": "string",
          "description": "执行参数（JSON）",
          "refType": null
        },
        "processClass": {
          "type": "string",
          "refType": null
        },
        "startTime": {
          "type": "string",
          "format": "date-time",
          "description": "开始执行时间",
          "refType": null
        },
        "taskId": {
          "type": "integer",
          "format": "int64",
          "refType": null
        },
        "taskStatus": {
          "type": "integer",
          "format": "int32",
          "description": "任务状态：1(未执行) 2(执行中)3(执行成功)-1(执行失败)",
          "refType": null
        },
        "taskType": {
          "type": "integer",
          "format": "int32",
          "description": "任务类型：1(导入) 2(导出)",
          "refType": null
        }
      },
      "title": "导出导出任务表"
    }
  }
}
```
